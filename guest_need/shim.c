#include <dlfcn.h>
#include "s2e.h"
#include <stdio.h>
#include <stdarg.h>

//#define sym_size 1050

int fprintf(FILE * stream, const char * format, ...)
{
  s2e_warning("[*] fprintf");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW); 
  int (*fun)(FILE *,const char*, va_list) = dlsym(handle, "vfprintf");

  va_list list;
  va_start(list, format);

  s2e_disable_symbolic_execution();
  int rr = fun(stream, format, list);
  s2e_enable_symbolic_execution();

  va_end(list);
  dlclose(handle);
  return rr;
}

int printf(const char* format, ...)
{
  s2e_warning("[*] printf");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW); 
  int (*fun)(const char*, va_list) = dlsym(handle, "vprintf");

  va_list list;
  va_start(list, format);

  s2e_disable_symbolic_execution();
  int rr = fun(format, list);
  s2e_enable_symbolic_execution();

  va_end(list);
  dlclose(handle);
  return rr;
}

int open(const char *pathname, int flags)
{
  s2e_warning("[*] open");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW); 
  int (*fun)(const char*, int) = dlsym(handle, "open");
  s2e_disable_symbolic_execution();
  int rr = fun(pathname, flags);
  s2e_enable_symbolic_execution();
  dlclose(handle);
  return rr;

}

FILE * fopen(const char * filename, const char * mode)
{
  s2e_warning("[*] fopen");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW); 
  FILE *(*fun)(const char*, const char*) = dlsym(handle, "fopen");
  s2e_disable_symbolic_execution();
  FILE * rr = fun(filename, mode);
  s2e_enable_symbolic_execution();
  dlclose(handle);
  return rr;
}

int __lxstat(int version, const char *file, struct stat *buf)
{
  s2e_warning("[*] __lxstat");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW);
  int (*fun)(int, const char *, struct stat *) = dlsym(handle, "__xstat");
  s2e_disable_symbolic_execution();
  int rr = fun(version, file, buf);
  s2e_enable_symbolic_execution();
  dlclose(handle);
  return rr;
}

void perror(const char *s)
{
  s2e_warning("[*] perror");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW);
  void (*fun)(const char *) = dlsym(handle, "perror");
  s2e_disable_symbolic_execution();
  fun(s);
  s2e_enable_symbolic_execution();
  dlclose(handle);  
}

int system(const char * command)
{
  s2e_warning("[*] system");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW);
  int (*fun)(const char*) = dlsym(handle, "system");
  s2e_disable_symbolic_execution();
  int rr = fun(command);
  s2e_enable_symbolic_execution();
  dlclose(handle);
  return rr;
}

int vsnprintf(char *str, size_t size, const char *format, va_list ap)
{
  s2e_warning("[*] vsnprintf");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW);
  int (*fun)(char *, size_t, const char *, va_list) = dlsym(handle, "vsnprintf");

  s2e_disable_symbolic_execution();
  int rr = fun(str, size, format, ap);
  s2e_enable_symbolic_execution();

  dlclose(handle);
  return rr;
}

FILE * fopen64(const char * filename, const char * mode)
{
  s2e_warning("[*] fopen64");
  void *handle = dlopen("/lib/i386-linux-gnu/libc.so.6", RTLD_NOW); 
  FILE *(*fun)(const char*, const char*) = dlsym(handle, "fopen64");
  s2e_disable_symbolic_execution();
  FILE * rr = fun(filename, mode);
  s2e_enable_symbolic_execution();
  dlclose(handle);
  return rr;
}

